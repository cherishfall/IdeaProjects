<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.innotek.system.dao.HomeDao" > 
<!-- Result Map-->
<resultMap id="BaseResultMap" type="java.util.Map" >
	<result column="TOTALPARKNUMBER" property="totalParkNumber" javaType="java.lang.Integer"/>
	<result column="TOTALBERTHNUMBER" property="totalBerthNumber" javaType="java.lang.Integer"/>
	<result column="TOTALSUCCESSPAYTIMES" property="totalSuccessPayTimes" javaType="java.lang.Integer"/>
	<result column="TOTALSUCCESSPAYFEE" property="totalSuccessPayFee" javaType="java.lang.Double"/>
	<result column="ALIPAYORDERPAYCOUNT" property="alipayOrderPayCount" javaType="java.lang.Integer"/>
	<result column="WXPAYORDERPAYCOUNT" property="wxpayOrderPayCount" javaType="java.lang.Integer"/>
	<result column="ALIPAYORDERPAYAMOUNT" property="alipayOrderPayAmount" javaType="java.lang.Double"/>
	<result column="WXPAYORDERPAYAMOUNT" property="wxpayOrderPayAmount" javaType="java.lang.Double"/>
	<result column="WXPAYORDERPAYCOUNT" property="wxpayOrderPayCount" javaType="java.lang.Integer"/>
	<result column="REGISTERUSERCOUNT" property="registerUserCount" javaType="java.lang.Integer"/>
	<result column="PAYORDERUSERCOUNT" property="payOrderUserCount" javaType="java.lang.Integer"/>
	<result column="ORDERCOMPLAINCOUNT" property="orderComplainCount" javaType="java.lang.Integer"/>
	<result column="ONLINECITYCOUNT" property="onlineCityCount" javaType="java.lang.Integer"/>
	<result column="REGISTERTOTALUSERCOUNT" property="registerTotalUserCount" javaType="java.lang.Integer"/>
</resultMap>

 

<resultMap id="PayMentAmouontResultMap" type="com.innotek.system.entity.HomePayAmountEntity" >
	<result column="pay_type" property="payType" javaType="java.lang.Integer"/>
	<result column="total_fee" property="totalFee" javaType="java.lang.String"/>
</resultMap>

<!-- *************************************首页p1.jsp查询分割线****************************************************** -->
<!-- 查询总停车点数,总泊位数 -->
<select id="queryTotalParkNumAndBerthMum" resultMap="BaseResultMap"  parameterType="java.util.Map">
	SELECT COUNT(1) totalParkNumber, SUM(TOTAL_BERTH_NUM) totalBerthNumber 
	FROM app_park 
	WHERE flag!='DELETE' AND IS_DYNAMIC=1 
	AND park_type=1 
	<trim>
		<if test="cityCode != null and cityCode != '' ">
			AND area_code LIKE '${cityCode}%'
		</if>
	</trim> 
</select>

<!-- 查询总成功缴费次数 ,缴费总金额,支付宝支付笔数,微信支付笔数,支付宝支付金额 ,微信支付金额 -->
<select id="queryStatDailyParam" resultMap="BaseResultMap"  parameterType="java.util.Map">
	  SELECT SUM(TRAN_SUCCESS_COUNT) totalSuccessPayTimes, 
	         SUM(ROUND(TRAN_SUCCESS_AMOUNT/100,2)) totalSuccessPayFee, 
	         SUM(ALIPAY_SUCCESS_COUNT) alipayOrderPayCount, 
      		 SUM(ROUND(ALIPAY_SUCCESS_AMOUNT/100,2)) alipayOrderPayAmount, 
      		 SUM(WXPAY_SUCCESS_COUNT) wxpayOrderPayCount, 
      	     SUM(ROUND(WXPAY_SUCCESS_AMOUNT/100,2)) wxpayOrderPayAmount 
      FROM app_stat_daily 
      WHERE day_time = #{queryDate} 
	  <trim>
		<if test="cityCode != null and cityCode != '' ">
			AND city_code = #{cityCode}
		</if>
	 </trim> 
      GROUP BY day_time
</select>

<!-- 查询 注册用户数-->
<select id="queryRegisterUserCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
	SELECT COUNT(1) registerTotalUserCount
	 FROM app_user u
	 LEFT JOIN app_user_ext e ON u.id = e.user_id
	 WHERE u.flag!='DELETE' 
	 <trim>
		<if test="cityCode != null and cityCode != '' ">
			AND e.CITY_CODE like '${cityCode}%' 
		</if>
		<if test="queryDate != null and queryDate != '' ">
			AND u.create_time BETWEEN to_date('${queryDate} 00:00:00','yyyy-MM-dd HH24:mi:ss') 
							  AND to_date('${queryDate} 23:59:59','yyyy-MM-dd HH24:mi:ss') 
		</if>
     </trim>
</select>

 

<!-- 查询今日缴费用户数-->
<select id="queryTodayPayOrderUserCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
	SELECT COUNT(DISTINCT(user_id)) payOrderUserCount
	FROM app_order 
    WHERE  ORDER_STATUS=200 AND NOTIFY_STATUS=1 
       AND to_char(pay_time,'yyyy-MM-dd') = #{queryDate}
       <trim>
		<if test="cityCode != null and cityCode != '' ">
			AND area_code like '${cityCode}%'
		</if>
	   </trim>
</select>

<!-- 查询总成功缴费次数 -->
<select id="queryTotalPayFeeCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
    SELECT SUM(A.tran_count) totalSuccessPayTimes
	FROM ( SELECT COUNT(1) tran_count
	  FROM app_order t
	  WHERE t.order_status=200 AND to_char(t.pay_time,'yyyy-MM-dd') = #{queryDate} 
	   <trim>
		<if test="cityCode != null and cityCode != '' ">
			AND t.area_code like '${cityCode}%' 
		</if>
	   </trim>
	 GROUP BY t.parkrecord_id)A 
</select>

<!-- 查询缴费成功总金额 -->
<select id="queryTotalPayFeeAmount" resultMap="BaseResultMap"  parameterType="java.util.Map">
    SELECT case when SUM(A.price)>0 then round(SUM(A.price)/100,2) else 0 end totalSuccessPayFee
	FROM( SELECT SUM(CASE WHEN t.PRICE>0 THEN t.price ELSE 0 END) price
        FROM app_order t
        WHERE t.order_status=200 AND to_char(t.pay_time,'yyyy-MM-dd') = #{queryDate}
        <trim>
		<if test="cityCode != null and cityCode != '' ">
			AND t.area_code like '${cityCode}%' 
		</if>
	   </trim>
        GROUP BY t.parkrecord_id)A
</select>

<!-- 查询支付宝支付笔数 -->
<select id="queryAlipayPayOrderCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
    SELECT  SUM(alipay_sunccess_count) alipayOrderPayCount
       FROM( SELECT COUNT(1) alipay_sunccess_count
         FROM app_order t 
         WHERE t.order_status=200 AND t.pay_type=1
           AND to_char(t.pay_time,'yyyy-MM-dd') = #{queryDate}
	        <trim>
				<if test="cityCode != null and cityCode != '' ">
					AND t.area_code like '${cityCode}%' 
				</if>
	   		</trim>
           GROUP BY t.parkrecord_id)A
</select>

<!-- 查询微信支付笔数 -->
<select id="queryWxPayOrderCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
    SELECT SUM(wxpay_sunccess_count) wxpayOrderPayCount
       FROM( SELECT COUNT(1) wxpay_sunccess_count
         FROM app_order t 
         WHERE t.order_status=200 AND t.pay_type=2
           AND to_char(t.pay_time,'yyyy-MM-dd') = #{queryDate}
           <trim>
				<if test="cityCode != null and cityCode != '' ">
					AND t.area_code like '${cityCode}%' 
				</if>
	   		</trim>  
           GROUP BY t.parkrecord_id )A 
</select>

<!-- 查询支付宝支付金额 -->
<select id="queryAlipayPayOrderAmount" resultMap="BaseResultMap"  parameterType="java.util.Map">
    SELECT case when SUM(alipay_success_amount)>0 then round(SUM(alipay_success_amount)/100,2) else 0 end alipayOrderPayAmount
       FROM( SELECT  SUM(CASE WHEN t.price>0 THEN t.price ELSE 0 END) alipay_success_amount
         FROM app_order t 
         WHERE t.order_status=200 AND t.pay_type=1
           AND to_char(t.pay_time,'yyyy-MM-dd') = #{queryDate}
	 	    <trim>
				<if test="cityCode != null and cityCode != '' ">
					AND t.area_code like '${cityCode}%'
				</if>
	   		</trim>   
           GROUP BY t.parkrecord_id)A
</select>

<!-- 查询微信支付金额 -->
<select id="queryWxpayPayOrderAmount" resultMap="BaseResultMap"  parameterType="java.util.Map">
    SELECT  case when SUM(wxpay_success_amount)>0 then round(SUM(wxpay_success_amount)/100,2) else 0 end wxpayOrderPayAmount
       FROM( SELECT SUM(CASE WHEN t.price>0 THEN t.price ELSE 0 END) wxpay_success_amount
         FROM app_order t 
         WHERE t.order_status=200 AND t.pay_type=2
         AND to_char(t.pay_time,'yyyy-MM-dd') = #{queryDate}
          <trim>
				<if test="cityCode != null and cityCode != '' ">
					AND t.area_code like '${cityCode}%' 
				</if>
	   	  </trim> 
         GROUP BY t.parkrecord_id )A 
</select>



<!-- 查询各支付方式缴费总数 -->
<select id="queryPayOrderAmount" resultMap="PayMentAmouontResultMap"  parameterType="java.util.Map">
	SELECT A.pay_type,ROUND(SUM(CASE WHEN A.pay_type=10 THEN B.ticket_fee ELSE A.price END)/100,2) total_fee FROM (       
		 SELECT order_no,price,pay_type,area_code FROM app_order 
		 	WHERE 1=1 AND order_status=200 
		 	AND pay_time BETWEEN to_date('${queryDate} 00:00:00','yyyy-MM-dd HH24:mi:ss') AND to_date('${queryDate} 23:59:59','yyyy-MM-dd HH24:mi:ss') 
	) A 
	LEFT JOIN (
		 SELECT order_no,ticket_fee FROM app_order_paylog 
		 	WHERE 1=1 AND is_paid=200 
		 	AND create_time BETWEEN to_date('${queryDate} 00:00:00','yyyy-MM-dd HH24:mi:ss') AND to_date('${queryDate} 23:59:59','yyyy-MM-dd HH24:mi:ss') 
    ) B ON A.order_no=B.order_no 
	WHERE 1=1 
	<trim>
		<if test="cityCode != null and cityCode != '' ">
			 AND A.area_code LIKE '${cityCode}%'		
		</if>
    </trim>
	GROUP BY A.pay_type 
</select>


<!-- 查询订单投诉个数-->
<select id="queryOrderComplainCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
	SELECT COUNT(1) orderComplainCount
	FROM app_order_complain 
	WHERE flag!='DELETE' 
	 AND to_char(CREATE_TIME,'yyyy-MM-dd') = #{queryDate}
	 <trim>
		<if test="cityCode != null and cityCode != '' ">
			AND  city_code like '${cityCode}%'  
		</if>
	 </trim>
</select>

<!-- 查询上线城市个数 -->
<select id="queryOnlineCityCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
   SELECT COUNT(1) onlineCityCount
   FROM base_area 
   WHERE flag!='DELETE' AND is_online=1  
     AND area_code LIKE '${cityCode}%'
</select>

<!-- ************************************p1.jsp结束******************************* -->
</mapper>   
