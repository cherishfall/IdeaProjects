<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.innotek.system.dao.HomeDao" > 
<!-- Result Map-->
<resultMap id="BaseResultMap" type="java.util.Map" >
	<result column="totalParkNumber" property="totalParkNumber" javaType="java.lang.Integer"/>
	<result column="totalBerthNumber" property="totalBerthNumber" javaType="java.lang.Integer"/>
	<result column="totalSuccessPayTimes" property="totalSuccessPayTimes" javaType="java.lang.Integer"/>
	<result column="totalSuccessPayFee" property="totalSuccessPayFee" javaType="java.lang.Double"/>
	<result column="alipayOrderPayCount" property="alipayOrderPayCount" javaType="java.lang.Integer"/>
	<result column="wxpayOrderPayCount" property="wxpayOrderPayCount" javaType="java.lang.Integer"/>
	<result column="alipayOrderPayAmount" property="alipayOrderPayAmount" javaType="java.lang.Double"/>
	<result column="wxpayOrderPayAmount" property="wxpayOrderPayAmount" javaType="java.lang.Double"/>
	<result column="wxpayOrderPayCount" property="wxpayOrderPayCount" javaType="java.lang.Integer"/>
	<result column="registerUserCount" property="registerUserCount" javaType="java.lang.Integer"/>
	<result column="payOrderUserCount" property="payOrderUserCount" javaType="java.lang.Integer"/>
	<result column="orderComplainCount" property="orderComplainCount" javaType="java.lang.Integer"/>
	<result column="onlineCityCount" property="onlineCityCount" javaType="java.lang.Integer"/>
	<result column="todayMemberRechargeAmount" property="todayMemberRechargeAmount" javaType="java.lang.Integer"/>
	<result column="todayMemberConsumeAmount" property="todayMemberConsumeAmount" javaType="java.lang.Integer"/>
	<result column="todayMemberRechargeUserCount" property="todayMemberRechargeUserCount" javaType="java.lang.Integer"/>
	<result column="todayMemberRechargeCount" property="todayMemberRechargeCount" javaType="java.lang.Integer"/>
</resultMap>

 

<resultMap id="PayMentAmouontResultMap" type="com.innotek.system.entity.HomePayAmountEntity" >
	<result column="pay_type" property="payType" javaType="java.lang.Integer"/>
	<result column="total_fee" property="totalFee" javaType="java.lang.String"/>
</resultMap>

<!-- *************************************首页p1.jsp查询分割线****************************************************** -->
<!-- 查询总停车点数,总泊位数 -->
<select id="queryTotalParkNumAndBerthMum" resultMap="BaseResultMap"  parameterType="java.util.Map">
	SELECT COUNT(1) totalParkNumber, SUM(TOTAL_BERTH_NUM) totalBerthNumber 
	FROM app_park 
	WHERE flag!='DELETE' AND IS_DYNAMIC=1 
	AND park_type=1 
	<trim>
		<if test="cityCode != null and cityCode != '' ">
			AND area_code LIKE '${cityCode}%'
		</if>
	</trim> 
</select>

<!-- 查询总成功缴费次数 ,缴费总金额,支付宝支付笔数,微信支付笔数,支付宝支付金额 ,微信支付金额 -->
<select id="queryStatDailyParam" resultMap="BaseResultMap"  parameterType="java.util.Map">
	  SELECT SUM(TRAN_SUCCESS_COUNT) totalSuccessPayTimes, 
	         SUM(ROUND(TRAN_SUCCESS_AMOUNT/100,2)) totalSuccessPayFee, 
	         SUM(ALIPAY_SUCCESS_COUNT) alipayOrderPayCount, 
      		 SUM(ROUND(ALIPAY_SUCCESS_AMOUNT/100,2)) alipayOrderPayAmount, 
      		 SUM(WXPAY_SUCCESS_COUNT) wxpayOrderPayCount, 
      	     SUM(ROUND(WXPAY_SUCCESS_AMOUNT/100,2)) wxpayOrderPayAmount 
      FROM app_stat_daily 
      WHERE day_time = #{queryDate} 
	  <trim>
		<if test="cityCode != null and cityCode != '' ">
			AND city_code = #{cityCode}
		</if>
	 </trim> 
      GROUP BY day_time
</select>

<!-- 查询 注册用户数-->
<select id="queryRegisterUserCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
	SELECT COUNT(1) registerTotalUserCount
	 FROM app_user_ext 
	 WHERE flag!='DELETE' 
	 <trim>
		<if test="cityCode != null and cityCode != '' ">
			AND CITY_CODE like '${cityCode}%' 
		</if>
		<if test="queryDate != null and queryDate != '' ">
			AND create_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s') 
							  AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s') 
		</if>
     </trim>
</select>

 

<!-- 查询今日缴费用户数-->
<select id="queryTodayPayOrderUserCount" resultType="Object"  parameterType="java.util.Map">
	SELECT DISTINCT(user_account)
	FROM app_order 
    WHERE ORDER_STATUS=200 AND NOTIFY_STATUS=1 
      and order_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s') 
                             AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s') 
       <trim>
		<if test="cityCode != null and cityCode != '' ">
			AND area_code like '${cityCode}%'
		</if>
	   </trim>
</select>

<!-- 查询总成功缴费次数 -->
<select id="queryTotalPayFeeCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
     SELECT COUNT(1) totalSuccessPayTimes
	 FROM app_order 
	 WHERE order_status = 200 
	   AND order_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s') 
                          AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s') 
        <if test="cityCode != null and cityCode != '' ">
			AND area_code like '${cityCode}%' 
		</if>
</select>

<!-- 查询缴费成功总金额 -->
<select id="queryTotalPayFeeAmount" resultMap="BaseResultMap"  parameterType="java.util.Map">
        SELECT CASE WHEN SUM(price)>0 THEN ROUND(SUM(price)/100,2) ELSE 0 END totalSuccessPayFee
        FROM app_order
         WHERE order_status=200 
           AND order_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s') 
                              AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s') 
    	<if test="cityCode != null and cityCode != '' ">
			AND area_code like '${cityCode}%' 
		</if>
</select>

<!-- 查询支付宝支付笔数 -->
<select id="queryAlipayPayOrderCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
     SELECT  COUNT(1) alipayOrderPayCount
     FROM app_order
     WHERE order_status=200 AND pay_type=1
       AND order_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s') 
                          AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s')
      <if test="cityCode != null and cityCode != '' ">
		   AND area_code like '${cityCode}%' 
	  </if>
</select>

<!-- 查询微信支付笔数 -->
<select id="queryWxPayOrderCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
     SELECT  COUNT(1) wxpayOrderPayCount
     FROM app_order
     WHERE order_status=200 AND pay_type = 2
       AND order_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s') 
                          AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s')
      <if test="cityCode != null and cityCode != '' ">
		   AND area_code like '${cityCode}%' 
	  </if>
</select>

<!-- 查询支付宝支付金额 -->
<select id="queryAlipayPayOrderAmount" resultMap="BaseResultMap"  parameterType="java.util.Map">
      SELECT CASE WHEN SUM(price)>0 THEN ROUND(SUM(price)/100,2) ELSE 0 END alipayOrderPayAmount
      FROM app_order
      WHERE order_status=200 AND pay_type=1
        AND order_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s') 
                           AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s')
        <if test="cityCode != null and cityCode != '' ">
			 AND area_code like '${cityCode}%'
		</if>
</select>

<!-- 查询微信支付金额 -->
<select id="queryWxpayPayOrderAmount" resultMap="BaseResultMap"  parameterType="java.util.Map">
     SELECT CASE WHEN SUM(price)>0 THEN ROUND(SUM(price)/100,2) ELSE 0 END wxpayOrderPayAmount
      FROM app_order
      WHERE order_status=200 AND pay_type = 2
        AND order_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s') 
                           AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s')
        <if test="cityCode != null and cityCode != '' ">
			 AND area_code like '${cityCode}%'
		</if>
</select>

<!-- 查询各支付方式缴费总数 -->
<select id="queryPayOrderAmount" resultMap="PayMentAmouontResultMap"  parameterType="java.util.Map">
	SELECT payment pay_type,ROUND(SUM(park_fee - TICKET_FEE -  DISCOUNT_FEE)/100,2) total_fee 
    FROM  app_order_paylog 
	WHERE is_paid=200
	 AND create_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s') 
	                     AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s') 
	<if test="cityCode != null and cityCode != '' ">
		 AND city_code LIKE '${cityCode}%'		
	</if>		
	GROUP BY payment
</select>

<!-- 获取停车券抵扣金额 -->
<select id="getHomeTicketFee" resultType="java.lang.String"  parameterType="java.util.Map">
	SELECT ROUND(SUM(TICKET_FEE + DISCOUNT_FEE)/100,2) preferential_fee 
    FROM  app_order_paylog 
	WHERE 1=1 AND is_paid=200 
	  AND create_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s') 
	                     AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s') 
	<if test="cityCode != null and cityCode != '' ">
		 AND city_code LIKE '${cityCode}%'		
	</if>		
			
</select>

<!-- 查询订单投诉个数-->
<select id="queryOrderComplainCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
	SELECT COUNT(1) orderComplainCount
	FROM app_order_complain 
	WHERE flag!='DELETE'
	  AND CREATE_TIME BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s') 
	                      AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s') 
	 <trim>
		<if test="cityCode != null and cityCode != '' ">
			AND  city_code like '${cityCode}%'  
		</if>
	 </trim>
</select>

<!-- 查询上线城市个数 -->
<select id="queryOnlineCityCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
   SELECT COUNT(1) onlineCityCount
   FROM base_area 
   WHERE flag!='DELETE' AND is_online=1  
     AND area_code LIKE '${cityCode}%'
</select>

<!-- ************************************p1.jsp结束******************************* -->

	<!-- 会员卡过去7天每天的充值总金额 -->
	<select id="queryMemberRechargeAmountByDay" resultType="java.lang.String"  parameterType="java.util.Map">
		SELECT IFNULL(ROUND(SUM(price)/100,2),0) memberRechargeAmount
		FROM app_member_card_order WHERE create_time
		BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s')
		AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s')
		AND order_status = 200
		<if test="areaCode != null and areaCode != '' ">
			AND area_code = #{areaCode}
		</if>
	</select>

	<!-- 查询各个充值金额的当日充值总金额 -->
	<select id="queryRechargeAmount" resultType="java.lang.String"  parameterType="java.util.Map">
		SELECT IFNULL(ROUND(SUM(price)/100,2),0) memberRechargeAmount
		FROM app_member_card_order WHERE create_time
		BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s')
		AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s')
		AND order_status = 200 and price = #{price}
		<if test="areaCode != null and areaCode != '' ">
			AND area_code like '${areaCode}%'
		</if>
	</select>

	<!-- 查询今日会员卡充值金额 -->
	<select id="getTodayMemberCardRechargeAmount" resultMap="BaseResultMap"  parameterType="java.util.Map">
		SELECT IFNULL(ROUND(SUM(price)/100,2),0) todayMemberRechargeAmount
		FROM app_member_card_order WHERE order_status = 200
		AND create_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s')
		AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s')
		<trim>
			<if test="cityCode != null and cityCode != '' ">
				AND area_code like '${cityCode}%'
			</if>
		</trim>
	</select>

	<!-- 查询今日会员卡消费金额 -->
	<select id="getTodayMemberCardConsumeAmount" resultMap="BaseResultMap"  parameterType="java.util.Map">
		SELECT IFNULL(ROUND((SUM(pay_fee)+SUM(member_card_fee))/100,2),0) todayMemberConsumeAmount
		FROM app_order_paylog WHERE is_paid = 200 and payment = 6
		AND create_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s')
		AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s')
		<trim>
			<if test="cityCode != null and cityCode != '' ">
				AND city_code like '${cityCode}%'
			</if>
		</trim>
	</select>

	<!-- 今日会员卡充值人数 -->
	<select id="getTodayMemberRechargeUserCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
		SELECT count(distinct(user_id)) todayMemberRechargeUserCount
		FROM app_member_card_order WHERE order_status = 200
		AND create_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s')
		AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s')
		<trim>
			<if test="cityCode != null and cityCode != '' ">
				AND area_code like '${cityCode}%'
			</if>
		</trim>
	</select>

	<!-- 今日会员卡充值订单数 -->
	<select id="getTodayMemberRechargeCount" resultMap="BaseResultMap"  parameterType="java.util.Map">
		SELECT count(1) todayMemberRechargeCount
		FROM app_member_card_order WHERE order_status = 200
		AND create_time BETWEEN STR_TO_DATE('${queryDate} 00:00:00','%Y-%m-%d %H:%i:%s')
		AND STR_TO_DATE('${queryDate} 23:59:59','%Y-%m-%d %H:%i:%s')
		<trim>
			<if test="cityCode != null and cityCode != '' ">
				AND area_code like '${cityCode}%'
			</if>
		</trim>
	</select>
</mapper>
